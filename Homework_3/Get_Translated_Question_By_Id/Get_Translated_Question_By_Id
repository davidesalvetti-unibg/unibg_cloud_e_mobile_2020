/**
 * TO BE REVIEWED
 * 
 */
var AWS = require('aws-sdk')
AWS.config.update({region: 'us-east-1'})
var translate = new AWS.Translate();


const connect_to_db = require('./db');

// GET BY QUESTION HANDLER

const questions = require('./Question');

module.exports.get_question_id = (event, context, callback) => {
    context.callbackWaitsForEmptyEventLoop = false;
    console.log('Received event:', JSON.stringify(event, null, 2));
    let body = {}
    if (event.body) {
        body = JSON.parse(event.body)
    }
    // set default
    if(!body.id) {
        callback(null, {
                    statusCode: 500,
                    headers: { 'Content-Type': 'text/plain' },
                    body: 'Could not fetch the watch next. Id is null.'
        })
    }
    
    if (!body.language) {
        body.language = 'en';
    }
    
    if (!body.level) {
        body.level = [0,1,2,3,4,5]
    }
    
    if (!body.doc_per_page) {
        body.doc_per_page = 3
    }
    
    if (!body.page) {
        body.page = 1
    }
    
    console.log("Connect to db..." + body.doc_per_page)
    connect_to_db().then(() => {
        console.log('=> get questions');
        questions.find({_id: body.id, questions_obj: { $elemMatch: {level: body.level}}}, 
                        {_id: 1, "questions_obj.$": 1})
        .then(async (quest) => {
                console.log("We found this questions:" + quest)
                console.log("Typeof:" + typeof(quest))
                
                for (var key in quest) {
                    console.log("Object extracted" + JSON.stringify(quest[key].questions_obj))
                    for (var it in quest[key].questions_obj) {
                        console.log("What the fuck is this "+ it + " " + quest[key].questions_obj[it] + JSON.stringify(quest[key].questions_obj[it]))
                        var question_obj = quest[key].questions_obj[it]
                        for (var it in question_obj) {
                            console.log("Livello:" + question_obj[it])
                            if (it != "level")
                                await traduci(question_obj,it, body.language);
                        }
                    }
                }
                callback(null, {
                    statusCode: 200,
                    body: JSON.stringify(quest)
                })
            }
        )
        .catch(err =>
            callback(null, {
                statusCode: err.statusCode || 500,
                headers: { 'Content-Type': 'text/plain' },
                body: 'Could not fetch the questions'
            })
        );
    });
};

// translating objects using AWS Translate
const traduci = async (question_obj,it,language) => {
    return new Promise((resolve, reject) => {
        var translateParams = {
            SourceLanguageCode: 'en',
            TargetLanguageCode: language,
            Text: JSON.stringify(question_obj[it])
        };
        console.log("inside we have " + it + " "+ question_obj[it] + " " + JSON.stringify(question_obj[it]))
        translate.translateText(translateParams, (err, data) => {
            if (err) console.log("Erros String: " + err)
            console.log("Latest Translation: " + data.TranslatedText)
            question_obj[it] = data.TranslatedText
            //to do bisogna lavorare sul dato, in ogni lingua ci sono delle virgolette diverse che vengono aggiunte.
            // probabilmente basta eliminare sempre il primo e l'ultimo carattere
            resolve();
        })
    });
}

